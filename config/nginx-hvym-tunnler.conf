# HVYM Tunnler Nginx Configuration
#
# This config handles:
# 1. Base domain (tunnel.hvym.link) - API, WebSocket, health endpoints
# 2. Subdomain routing (GADDR.tunnel.hvym.link) - Tunnel proxy to clients
#
# Install:
#   sudo cp config/nginx-hvym-tunnler.conf /etc/nginx/sites-available/hvym-tunnler
#   sudo ln -sf /etc/nginx/sites-available/hvym-tunnler /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# After installing, run certbot to add SSL:
#   certbot certonly --manual --preferred-challenges dns -d tunnel.hvym.link -d "*.tunnel.hvym.link"
#   certbot install --nginx -d tunnel.hvym.link -d "*.tunnel.hvym.link"

upstream tunnler {
    server 127.0.0.1:8000;
    keepalive 32;
}

# Map to extract Stellar address from subdomain
# Example: GADDR.tunnel.hvym.link -> GADDR
map $host $stellar_address {
    ~*^(?<addr>[A-Za-z0-9]+)\.tunnel\.hvym\.link$ $addr;
    default "";
}

# HTTP server for base domain (API, WebSocket, certbot)
server {
    listen 80;
    server_name tunnel.hvym.link;

    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # WebSocket for tunnel connections
    location /connect {
        proxy_pass http://tunnler;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # API and health endpoints
    location / {
        proxy_pass http://tunnler;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTP server for tunnel subdomains (GADDR.tunnel.hvym.link)
server {
    listen 80;
    server_name *.tunnel.hvym.link;

    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # All requests to subdomains go through the proxy endpoint
    location / {
        # Rewrite to /proxy path with stellar address in header
        proxy_pass http://tunnler/proxy/$uri$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Stellar-Address $stellar_address;
    }
}

# Note: HTTPS server blocks will be added by certbot after SSL setup
